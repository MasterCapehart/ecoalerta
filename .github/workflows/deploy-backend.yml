name: Desplegar Backend a Azure

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: ecoalerta-backend
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Instalar dependencias del sistema
      run: |
        sudo apt-get update
        sudo apt-get install -y libpq-dev gdal-bin libgdal-dev python3-gdal

    - name: Preparar archivos para despliegue
      run: |
        echo "=== Preparando archivos para despliegue ==="
        cd backend
        # Asegurar que startup.sh tenga permisos de ejecución
        chmod +x startup.sh
        # Verificar que el archivo existe y está en la raíz
        ls -la startup.sh
        echo ""
        echo "=== Contenido de startup.sh ==="
        cat startup.sh
        echo ""
        echo "=== Verificando estructura del directorio ==="
        ls -la | head -10
        echo ""
        echo "=== Verificando que startup.sh esté en la raíz ==="
        pwd
        test -f startup.sh && echo "✅ startup.sh encontrado en $(pwd)" || echo "❌ startup.sh NO encontrado"
    
    - name: Crear ZIP para despliegue
      run: |
        cd backend
        zip -r ../backend-deploy.zip . -x "*.git*" "*.pyc" "__pycache__/*" "*.log" "venv/*" ".venv/*"
        cd ..
        ls -lh backend-deploy.zip
    
    - name: Extraer credenciales del publish profile
      id: extract-creds
      run: |
        echo "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" > /tmp/publish-profile.xml
        echo "=== Verificando publish profile ==="
        head -1 /tmp/publish-profile.xml
        
        # Extraer credenciales - funciona con o sin comillas
        # Buscar userName=VALOR o userName="VALOR"
        USERNAME=$(grep -oE 'userName=["]?[^" >]+["]?' /tmp/publish-profile.xml | head -1 | sed 's/userName=//;s/"//g')
        PASSWORD=$(grep -oE 'userPWD=["]?[^" >]+["]?' /tmp/publish-profile.xml | head -1 | sed 's/userPWD=//;s/"//g')
        PUBLISH_URL=$(grep -oE 'publishUrl=["]?[^" >]+["]?' /tmp/publish-profile.xml | grep "scm" | head -1 | sed 's/publishUrl=//;s/"//g;s/:443//')
        
        # Validar que las variables no estén vacías
        if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ] || [ -z "$PUBLISH_URL" ]; then
          echo "❌ Error: No se pudieron extraer las credenciales"
          echo "USERNAME: '$USERNAME'"
          echo "PASSWORD: '${PASSWORD:0:5}...'"
          echo "PUBLISH_URL: '$PUBLISH_URL'"
          echo ""
          echo "=== Debug: Buscando patrones ==="
          grep -o 'userName=[^ ]*' /tmp/publish-profile.xml | head -3
          grep -o 'publishUrl=[^ ]*' /tmp/publish-profile.xml | grep scm | head -1
          exit 1
        fi
        
        echo "username=$USERNAME" >> $GITHUB_OUTPUT
        echo "password=$PASSWORD" >> $GITHUB_OUTPUT
        echo "publish_url=$PUBLISH_URL" >> $GITHUB_OUTPUT
        
        echo "✅ Credenciales extraídas correctamente"
        echo "Username: ${USERNAME:0:15}..."
        echo "Publish URL: $PUBLISH_URL"
    
    - name: Desplegar usando ZIP Deploy API
      run: |
        USERNAME="${{ steps.extract-creds.outputs.username }}"
        PASSWORD="${{ steps.extract-creds.outputs.password }}"
        PUBLISH_URL="${{ steps.extract-creds.outputs.publish_url }}"
        
        if [ -z "$PUBLISH_URL" ]; then
          echo "❌ Error: PUBLISH_URL está vacío"
          exit 1
        fi
        
        echo "=== Iniciando despliegue ==="
        echo "URL: https://${PUBLISH_URL}/api/zipdeploy"
        
        RESPONSE=$(curl -X POST \
          -u "${USERNAME}:${PASSWORD}" \
          --data-binary @backend-deploy.zip \
          -H "Content-Type: application/zip" \
          -w "\nHTTP_CODE:%{http_code}" \
          "https://${PUBLISH_URL}/api/zipdeploy?isAsync=true" \
          -v 2>&1)
        
        HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d: -f2)
        BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE/d' | tail -20)
        
        echo "HTTP Code: $HTTP_CODE"
        echo "Response: $BODY"
        
        if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "202" ]; then
          echo "❌ Error en el despliegue. HTTP Code: $HTTP_CODE"
          exit 1
        fi
        
        echo "✅ Despliegue iniciado correctamente (HTTP $HTTP_CODE)"

