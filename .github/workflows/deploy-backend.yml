name: Desplegar Backend a Azure

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: ecoalerta-backend
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Instalar dependencias del sistema
      run: |
        sudo apt-get update
        sudo apt-get install -y libpq-dev gdal-bin libgdal-dev python3-gdal

    - name: Preparar archivos para despliegue
      run: |
        echo "=== Preparando archivos para despliegue ==="
        cd backend
        # Asegurar que los scripts tengan permisos de ejecuci√≥n
        chmod +x startup.sh build.sh || true
        echo "=== Verificando estructura del directorio ==="
        ls -la | head -15
        cd ..
    
    - name: Crear ZIP para despliegue (con estructura correcta para Oryx)
      run: |
        echo "=== Creando ZIP para despliegue ==="
        cd backend
        # Verificar que los archivos cr√≠ticos existen
        echo "=== Verificando archivos cr√≠ticos ==="
        ls -la manage.py requirements.txt ecoalerta/settings.py ecoalerta/middleware.py || echo "‚ö†Ô∏è Algunos archivos no encontrados"
        # Crear ZIP incluyendo todo lo necesario para que Oryx construya
        zip -r ../backend-deploy.zip . \
          -x "*.git*" "*.pyc" "__pycache__/*" "*.log" "venv/*" ".venv/*" "antenv/*" "*.sqlite3" "*.db"
        cd ..
        echo "=== Verificando contenido del ZIP ==="
        unzip -l backend-deploy.zip | grep -E "(startup.sh|build.sh|requirements.txt|manage.py|middleware.py|settings.py)" | head -15
        ls -lh backend-deploy.zip
        echo "=== Verificando que middleware.py est√© en el ZIP ==="
        unzip -l backend-deploy.zip | grep "middleware.py" || echo "‚ö†Ô∏è middleware.py no encontrado en ZIP"

    - name: Desplegar a Azure App Service
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ./backend-deploy.zip

    - name: Verificar despliegue
      run: |
        echo "‚úÖ Despliegue completado"
        echo ""
        echo "üìù IMPORTANTE: Si es la primera vez o el startup command no est√° configurado,"
        echo "   ejecuta localmente: ./fix-backend-startup.sh"
        echo "   El comando de inicio persiste en Azure entre despliegues."

        
