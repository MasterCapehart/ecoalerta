name: Desplegar Backend a Azure

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: ecoalerta-backend
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Instalar dependencias del sistema
      run: |
        sudo apt-get update
        sudo apt-get install -y libpq-dev gdal-bin libgdal-dev python3-gdal

    - name: Preparar archivos para despliegue
      run: |
        echo "=== Preparando archivos para despliegue ==="
        cd backend
        # Asegurar que startup.sh tenga permisos de ejecución
        chmod +x startup.sh
        # Verificar que el archivo existe y está en la raíz
        ls -la startup.sh
        echo ""
        echo "=== Contenido de startup.sh ==="
        cat startup.sh
        echo ""
        echo "=== Verificando estructura del directorio ==="
        ls -la | head -10
        echo ""
        echo "=== Verificando que startup.sh esté en la raíz ==="
        pwd
        test -f startup.sh && echo "✅ startup.sh encontrado en $(pwd)" || echo "❌ startup.sh NO encontrado"
    
    - name: Crear ZIP para despliegue
      run: |
        cd backend
        zip -r ../backend-deploy.zip . -x "*.git*" "*.pyc" "__pycache__/*" "*.log" "venv/*" ".venv/*"
        cd ..
        ls -lh backend-deploy.zip
    
    - name: Instalar Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
    
    - name: Login a Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
      continue-on-error: true
    
    - name: Desplegar usando Azure CLI
      if: success() || failure()
      run: |
        # Intentar usar Azure CLI para desplegar
        if az account show &>/dev/null; then
          echo "✅ Autenticado con Azure CLI"
          az webapp deployment source config-zip \
            --resource-group ecoalerta1 \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --src backend-deploy.zip
        else
          echo "⚠️ No autenticado con Azure CLI, intentando método alternativo..."
          # Método alternativo: usar publish profile si está disponible
          if [ -n "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" ]; then
            echo "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" > /tmp/publish-profile.xml
            USERNAME=$(grep -oE 'userName=["]?[^" >]+["]?' /tmp/publish-profile.xml | head -1 | sed 's/userName=//;s/"//g')
            PASSWORD=$(grep -oE 'userPWD=["]?[^" >]+["]?' /tmp/publish-profile.xml | head -1 | sed 's/userPWD=//;s/"//g')
            PUBLISH_URL="ecoalerta-backend-cmfbgrb3bgd0ephd.scm.chilecentral-01.azurewebsites.net"
            
            if [ -n "$USERNAME" ] && [ -n "$PASSWORD" ] && [ "$USERNAME" != "REDACTED" ]; then
              echo "Usando credenciales del publish profile..."
              curl -X POST \
                -u "${USERNAME}:${PASSWORD}" \
                --data-binary @backend-deploy.zip \
                -H "Content-Type: application/zip" \
                "https://${PUBLISH_URL}/api/zipdeploy?isAsync=true"
            else
              echo "❌ No se pudieron obtener credenciales válidas"
              exit 1
            fi
          else
            echo "❌ No hay credenciales disponibles"
            exit 1
          fi
        fi

